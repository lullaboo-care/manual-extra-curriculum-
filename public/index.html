<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lullaboo Data Transfer Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --background-light: #f4f4f4;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .transfer-type-option {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .transfer-type-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .progress-bar {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }

        .log-console {
            max-height: 300px;
            overflow-y: auto;
            background-color: #1f2937;
            color: #f3f4f6;
        }

        .campus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .campus-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .campus-item.selected {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: var(--primary-color);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="app-container">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center">
                <img src="lullaboo-logo.png" alt="Lullaboo Logo" class="h-16 mr-4">
                <h1 class="text-3xl font-bold text-gray-800">Data Transfer Tool</h1>
            </div>
            <div class="space-x-4">
                <span class="text-sm text-gray-600" id="connectionStatus">
                    <i class="fas fa-circle text-red-500 mr-2"></i>Disconnected
                </span>
            </div>
        </header>

        <!-- Main Content -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <!-- Navigation Tabs -->
            <div class="border-b">
                <nav class="flex">
                    <button 
                        class="flex-1 py-4 text-center font-semibold text-gray-600 hover:bg-gray-50 tab-btn active" 
                        data-tab="transfer"
                    >
                        <i class="fas fa-exchange-alt mr-2"></i>Data Transfer
                    </button>
                    <button 
                        class="flex-1 py-4 text-center font-semibold text-gray-600 hover:bg-gray-50 tab-btn" 
                        data-tab="config"
                    >
                        <i class="fas fa-cog mr-2"></i>Configuration
                    </button>
                    <button 
                        class="flex-1 py-4 text-center font-semibold text-gray-600 hover:bg-gray-50 tab-btn" 
                        data-tab="about"
                    >
                        <i class="fas fa-info-circle mr-2"></i>About
                    </button>
                </nav>
            </div>

            <!-- Transfer Tab -->
            <div id="transfer-tab" class="tab-content p-6 block">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Transfer Type Selector -->
                    <div>
                        <h2 class="text-xl font-semibold mb-4">Select Transfer Type</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div 
                                class="transfer-type-option p-4 border rounded-lg text-center selected" 
                                data-type="childSchedule"
                            >
                                <i class="fas fa-calendar-alt text-2xl mb-2 text-green-600"></i>
                                <h3 class="font-semibold">Child Schedule</h3>
                                <p class="text-sm text-gray-600">Transfer schedule data</p>
                            </div>
                            <div 
                                class="transfer-type-option p-4 border rounded-lg text-center" 
                                data-type="authorization"
                            >
                                <i class="fas fa-user-check text-2xl mb-2 text-blue-600"></i>
                                <h3 class="font-semibold">Authorization</h3>
                                <p class="text-sm text-gray-600">Transfer authorization data</p>
                            </div>
                        </div>
                    </div>

                    <!-- Campus Selection -->
                    <div>
                        <h2 class="text-xl font-semibold mb-4">Select Campuses</h2>
                        <div id="campusList" class="campus-grid max-h-64 overflow-y-auto">
                            <!-- Campuses will be dynamically populated here -->
                        </div>
                        <div class="flex justify-between mt-4">
                            <button id="selectAllBtn" class="btn btn-secondary">
                                <i class="fas fa-check-square mr-2"></i>Select All
                            </button>
                            <button id="deselectAllBtn" class="btn btn-secondary">
                                <i class="fas fa-square mr-2"></i>Deselect All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Transfer Controls -->
                <div class="mt-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <button id="startTransferBtn" class="btn btn-primary">
                            <i class="fas fa-play mr-2"></i>Start Transfer
                        </button>
                        <button id="stopTransferBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-stop mr-2"></i>Stop Transfer
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div 
                            id="progressBar" 
                            class="progress-bar h-full text-xs text-white text-center" 
                            style="width:0%"
                        >
                            0%
                        </div>
                    </div>

                    <!-- Status Panels -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="card bg-green-50 p-4 text-center">
                            <h3 class="font-semibold text-green-800">Total Campuses</h3>
                            <div id="totalCampuses" class="text-2xl font-bold text-green-600">0</div>
                        </div>
                        <div class="card bg-yellow-50 p-4 text-center">
                            <h3 class="font-semibold text-yellow-800">In Progress</h3>
                            <div id="inProgressCount" class="text-2xl font-bold text-yellow-600">0</div>
                        </div>
                        <div class="card bg-blue-50 p-4 text-center">
                            <h3 class="font-semibold text-blue-800">Records Processed</h3>
                            <div id="recordsProcessed" class="text-2xl font-bold text-blue-600">0</div>
                        </div>
                    </div>
                </div>

                <!-- Log Console -->
                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-4">Transfer Log</h3>
                    <div 
                        id="logConsole" 
                        class="log-console p-4 rounded-lg max-h-64 overflow-y-auto"
                    >
                        <!-- Log entries will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="config-tab" class="tab-content p-6 hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-4">FileMaker Credentials</h2>
                        <div class="space-y-4">
                            <input 
                                type="text" 
                                id="filemakerUsername" 
                                placeholder="Username" 
                                class="w-full p-2 border rounded"
                            >
                            <input 
                                type="password" 
                                id="filemakerPassword" 
                                placeholder="Password" 
                                class="w-full p-2 border rounded"
                            >
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold mb-4">Firebase Configuration</h2>
                        <div class="space-y-4">
                            <input 
                                type="text" 
                                id="firebaseUrlSchedule" 
                                placeholder="Schedule Database URL" 
                                class="w-full p-2 border rounded"
                            >
                            <input 
                                type="text" 
                                id="firebaseUrlAuth" 
                                placeholder="Authorization Database URL" 
                                class="w-full p-2 border rounded"
                            >
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <h2 class="text-xl font-semibold mb-4">Service Account Key</h2>
                    <textarea 
                        id="serviceAccountKey" 
                        rows="5" 
                        placeholder="Paste Firebase service account JSON" 
                        class="w-full p-2 border rounded"
                    ></textarea>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <button id="saveConfigBtn" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Configuration
                    </button>
                    <button id="testConnectionBtn" class="btn btn-secondary">
                        <i class="fas fa-plug mr-2"></i>Test Connection
                    </button>
                </div>
            </div>

            <!-- About Tab -->
            <div id="about-tab" class="tab-content p-6 hidden">
                <div class="text-center">
                    <img src="lullaboo-logo.png" alt="Lullaboo Logo" class="mx-auto h-32 mb-6">
                    <h2 class="text-2xl font-bold mb-4">Lullaboo Data Transfer Tool</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto mb-6">
                        A powerful solution for seamlessly transferring child schedule and authorization 
                        data from FileMaker databases to Firebase Realtime Database.
                    </p>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="card p-6 bg-blue-50">
                            <i class="fas fa-calendar text-4xl text-blue-600 mb-4"></i>
                            <h3 class="font-semibold mb-2">Child Schedule</h3>
                            <p class="text-sm text-gray-600">
                                Efficiently transfer and synchronize child schedule data across campuses
                            </p>
                        </div>
                        <div class="card p-6 bg-green-50">
                            <i class="fas fa-user-check text-4xl text-green-600 mb-4"></i>
                            <h3 class="font-semibold mb-2">Authorization Management</h3>
                            <p class="text-sm text-gray-600">
                                Streamline child authorization record transfers and management
                            </p>
                        </div>
                        <div class="card p-6 bg-purple-50">
                            <i class="fas fa-database text-4xl text-purple-600 mb-4"></i>
                            <h3 class="font-semibold mb-2">Firebase Integration</h3>
                            <p class="text-sm text-gray-600">
                                Robust and secure integration with Firebase Realtime Database
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Tailwind CSS Classes -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2196F3'
                    }
                }
            }
        }
    </script>

    <!-- Main Application Script -->
    <script>
        // API Endpoints
        const API_BASE = '';  // Use relative URLs
        const API = {
            START_TRANSFER: `${API_BASE}/api/start_transfer`,
            STOP_TRANSFER: `${API_BASE}/api/stop_transfer`,
            TRANSFER_STATUS: `${API_BASE}/api/transfer_status`,
            TEST_CONNECTION: `${API_BASE}/api/test_connection`,
            CAMPUS_LIST: `${API_BASE}/api/campus_list`
        };

        // DOM Elements
        const elements = {
            campusList: document.getElementById('campusList'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            startTransferBtn: document.getElementById('startTransferBtn'),
            stopTransferBtn: document.getElementById('stopTransferBtn'),
            progressBar: document.getElementById('progressBar'),
            logConsole: document.getElementById('logConsole'),
            totalCampusesElement: document.getElementById('totalCampuses'),
            inProgressCountElement: document.getElementById('inProgressCount'),
            recordsProcessedElement: document.getElementById('recordsProcessed'),
            connectionStatus: document.getElementById('connectionStatus'),
            
            // Configuration Elements
            filemakerUsername: document.getElementById('filemakerUsername'),
            filemakerPassword: document.getElementById('filemakerPassword'),
            firebaseUrlSchedule: document.getElementById('firebaseUrlSchedule'),
            firebaseUrlAuth: document.getElementById('firebaseUrlAuth'),
            serviceAccountKey: document.getElementById('serviceAccountKey'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            testConnectionBtn: document.getElementById('testConnectionBtn')
        };

    // State Management
    const state = {
        selectedCampuses: new Set(),
        transferType: 'childSchedule',
        isTransferRunning: false,
        campusData: {}
    };

        // Tab Switching Logic
        function setupTabNavigation() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(t => {
                        t.classList.add('hidden');
                        t.classList.remove('block');
                    });
                    
                    // Add active class to clicked tab and show corresponding content
                    btn.classList.add('active');
                    const tabContent = document.getElementById(`${btn.dataset.tab}-tab`);
                    tabContent.classList.remove('hidden');
                    tabContent.classList.add('block');
                });
            });
        }

        // Transfer Type Selection
        function setupTransferTypeSelection() {
            document.querySelectorAll('.transfer-type-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.transfer-type-option').forEach(opt => 
                        opt.classList.remove('selected')
                    );
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Update transfer type
                    state.transferType = option.dataset.type;
                });
            });
        }

        // Fetch Campus List
        async function fetchCampusList() {
            try {
                const response = await fetch(API.CAMPUS_LIST);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    state.campusData = data.campuses;
                    populateCampusList();
                    updateConnectionStatus(true);
                } else {
                    throw new Error('Failed to load campus list');
                }
            } catch (error) {
                console.error('Error loading campus list:', error);
                updateConnectionStatus(false);
                logMessage(error.message, 'error');
            }
        }

        // Populate Campus List
        function populateCampusList() {
            elements.campusList.innerHTML = '';
            
            Object.entries(state.campusData).forEach(([campusKey, campus]) => {
                const campusElement = document.createElement('div');
                campusElement.className = 'campus-item p-2 border rounded hover:bg-gray-100';
                campusElement.dataset.campus = campusKey;
                campusElement.innerHTML = `
                    <label class="flex items-center">
                        <input 
                            type="checkbox" 
                            class="mr-2" 
                            data-campus="${campusKey}"
                        >
                        ${campus.name}
                    </label>
                `;
                
                campusElement.addEventListener('click', (e) => {
                    const checkbox = campusElement.querySelector('input[type="checkbox"]');
                    
                    // Prevent toggle if clicked directly on checkbox
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    // Update selected campuses
                    if (checkbox.checked) {
                        state.selectedCampuses.add(campusKey);
                        campusElement.classList.add('selected');
                    } else {
                        state.selectedCampuses.delete(campusKey);
                        campusElement.classList.remove('selected');
                    }
                    
                    // Update total campuses display
                    updateTotalCampuses();
                });
                
                elements.campusList.appendChild(campusElement);
            });
            
            // Update total campuses
            updateTotalCampuses();
        }

        // Update Total Campuses
        function updateTotalCampuses() {
            elements.totalCampusesElement.textContent = state.selectedCampuses.size;
        }

        // Select/Deselect All Campuses
        function setupCampusSelectionButtons() {
            elements.selectAllBtn.addEventListener('click', () => {
                document.querySelectorAll('#campusList .campus-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const campusKey = item.dataset.campus;
                    
                    checkbox.checked = true;
                    state.selectedCampuses.add(campusKey);
                    item.classList.add('selected');
                });
                
                updateTotalCampuses();
            });

            elements.deselectAllBtn.addEventListener('click', () => {
                document.querySelectorAll('#campusList .campus-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const campusKey = item.dataset.campus;
                    
                    checkbox.checked = false;
                    state.selectedCampuses.delete(campusKey);
                    item.classList.remove('selected');
                });
                
                updateTotalCampuses();
            });
        }

        // Log Message
        function logMessage(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-b ${
                type === 'info' ? 'text-green-500' : 
                type === 'error' ? 'text-red-500' : 
                'text-blue-500'
            }`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            elements.logConsole.appendChild(logEntry);
            elements.logConsole.scrollTop = elements.logConsole.scrollHeight;
        }

        // Update Connection Status
        function updateConnectionStatus(isConnected) {
            const statusElement = elements.connectionStatus;
            if (isConnected) {
                statusElement.innerHTML = `<i class="fas fa-circle text-green-500 mr-2"></i>Connected`;
                statusElement.classList.remove('text-red-500');
                statusElement.classList.add('text-green-500');
            } else {
                statusElement.innerHTML = `<i class="fas fa-circle text-red-500 mr-2"></i>Disconnected`;
                statusElement.classList.remove('text-green-500');
                statusElement.classList.add('text-red-500');
            }
        }

        // Start Transfer
        async function startTransfer() {
            // Validate campus selection
            if (state.selectedCampuses.size === 0) {
                logMessage('Please select at least one campus', 'error');
                return;
            }

            // Validate configuration
            if (!validateConfiguration()) {
                logMessage('Please complete all configuration fields', 'error');
                return;
            }

            // Prepare transfer payload
            const payload = {
                campuses: Array.from(state.selectedCampuses),
                filemaker_username: elements.filemakerUsername.value,
                filemaker_password: elements.filemakerPassword.value,
                firebase_url: state.transferType === 'childSchedule' 
                    ? elements.firebaseUrlSchedule.value 
                    : elements.firebaseUrlAuth.value,
                service_account_json: elements.serviceAccountKey.value,
                transfer_type: state.transferType
            };

            // Add authorization template ID if needed
            if (state.transferType === 'authorization') {
                payload.authorization_template_id = 
                    document.getElementById('authorizationTemplateId')?.value;
            }

            try {
                const response = await fetch(API.START_TRANSFER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    logMessage('Transfer process started successfully', 'info');
                    state.isTransferRunning = true;
                    elements.startTransferBtn.disabled = true;
                    elements.stopTransferBtn.disabled = false;
                    
                    // Start status checks
                    startStatusChecks();
                } else {
                    logMessage(`Transfer start failed: ${result.message}`, 'error');
                }
            } catch (error) {
                logMessage(`Error starting transfer: ${error.message}`, 'error');
            }
        }

        // Validate Configuration
        function validateConfiguration() {
            // Check required fields
            const requiredFields = [
                elements.filemakerUsername,
                elements.filemakerPassword,
                elements.serviceAccountKey
            ];

            // Add conditional validation based on transfer type
            if (state.transferType === 'childSchedule') {
                requiredFields.push(elements.firebaseUrlSchedule);
            } else {
                requiredFields.push(elements.firebaseUrlAuth);
            }

            // Check if all required fields have values
            return requiredFields.every(field => field.value.trim() !== '');
        }

        // Initialize Application
        function initializeApp() {
            // Setup event listeners
            setupTabNavigation();
            setupTransferTypeSelection();
            setupCampusSelectionButtons();

            // Fetch campus list
            fetchCampusList();

            // Add transfer button listeners
            elements.startTransferBtn.addEventListener('click', startTransfer);
            elements.stopTransferBtn.addEventListener('click', stopTransfer);

            // Load saved configuration
            loadSavedConfiguration();
        }

        // Load Saved Configuration
        function loadSavedConfiguration() {
            // Load from localStorage
            elements.filemakerUsername.value = 
                localStorage.getItem('filemakerUsername') || '';
            elements.firebaseUrlSchedule.value = 
                localStorage.getItem('firebaseUrlSchedule') || '';
            elements.firebaseUrlAuth.value = 
                localStorage.getItem('firebaseUrlAuth') || '';
        }

        // Save Configuration
        function saveConfiguration() {
            try {
                localStorage.setItem('filemakerUsername', 
                    elements.filemakerUsername.value);
                localStorage.setItem('firebaseUrlSchedule', 
                    elements.firebaseUrlSchedule.value);
                localStorage.setItem('firebaseUrlAuth', 
                    elements.firebaseUrlAuth.value);
                
                logMessage('Configuration saved successfully', 'info');
            } catch (error) {
                logMessage('Failed to save configuration', 'error');
            }
        }

        // Test Connection
        async function testConnection() {
            if (!validateConfiguration()) {
                logMessage('Please complete all configuration fields', 'error');
                return;
            }

            const payload = {
                filemaker_username: elements.filemakerUsername.value,
                filemaker_password: elements.filemakerPassword.value,
                firebase_url: state.transferType === 'childSchedule' 
                    ? elements.firebaseUrlSchedule.value 
                    : elements.firebaseUrlAuth.value,
                service_account_json: elements.serviceAccountKey.value,
                test_campus: 'heartland',
                transfer_type: state.transferType
            };

            try {
                const response = await fetch(API.TEST_CONNECTION, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // Log connection test results
                if (result.filemaker.success) {
                    logMessage('FileMaker connection successful', 'info');
                } else {
                    logMessage(`FileMaker connection failed: ${result.filemaker.message}`, 'error');
                }

                if (result.firebase.success) {
                    logMessage('Firebase connection successful', 'info');
                } else {
                    logMessage(`Firebase connection failed: ${result.firebase.message}`, 'error');
                }
            } catch (error) {
                logMessage(`Connection test failed: ${error.message}`, 'error');
            }
        }

        // Add configuration button listeners
        elements.saveConfigBtn.addEventListener('click', saveConfiguration);
        elements.testConnectionBtn.addEventListener('click', testConnection);

        // Start the application when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>